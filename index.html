<html>
<head>
<title>jessicas' Forms Form</title>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="jquery.min.js"></script>

<style>
table, th, td {
   border: 1px solid black;
}

</style>

<script>
var rule_count = 3;
var example_count = 6;

var allData = initAllData();


function initAllData() {
    blank = {
        rules: [],
        examples: [],
    }

    for (var rule_i=0; rule_i < rule_count; rule_i++) {
        blank.rules.push({
            target: "[term]",
            source: "[term]",
        })
    }

    for (var example_i=0; example_i < example_count; example_i++) {
        blank.examples.push({
            target: "",
            source: "",
        })
    }

    return blank;
}


function updateAllData() {
    var getValFromData = function(d) {return $(d).val();};

    source_rules = d3.selectAll(".source_rule")[0].map(getValFromData);
    target_rules = d3.selectAll(".target_rule")[0].map(getValFromData);

    source_examples = d3.selectAll(".source_example")[0].map(getValFromData);
    target_examples = d3.selectAll(".target_example")[0].map(getValFromData);

    blank = {
        rules: [],
        examples: [],
    }

    for (var rule_i=0; rule_i < rule_count; rule_i++) {
        blank.rules.push({
            source: source_rules[rule_i],
            target: target_rules[rule_i],
        })
    }

    for (var example_i=0; example_i < example_count; example_i++) {
        blank.examples.push({
            source: source_examples[example_i],
            target: target_examples[example_i],
        })
    }

    return blank;
}


function applyRuleToExample(rule, example) {

    if (example == "") {
        return "";
    }

    var result;

    result = rule.replace("[term]", example);

    var match = /\((.+?)->(.+?)\)/g.exec(result);

    if (match) {
        result = result.replace(/\(.+?->.+?\)/, "")

        // get the string right before it
        replace_this_string_len = match[1].length;

        could_be_a_match = result.substr(match.index - replace_this_string_len, replace_this_string_len);

        if (could_be_a_match == match[1]) {
            result = result.substr(0, match.index - replace_this_string_len)
                + match[2]
                + result.substr(match.index, result.length - 1);
        }
    }

    return result;
}


function pairOffData(allData) {

    result = [];
    for (var example_i=0; example_i < example_count; example_i++) {
        var newList = [];
        for (var rule_i=0; rule_i < rule_count; rule_i++) {

            newList.push({
                source: applyRuleToExample(
                    allData.rules[rule_i].source,
                    allData.examples[example_i].source
                ),
                target: applyRuleToExample(
                    allData.rules[rule_i].target,
                    allData.examples[example_i].target
                ),
            });
        }
        result.push(newList);
    }

    return result;
}


function addHoizontalPlusMinus(cell) {
    cell.selectAll("*").remove();

    cell.append('div')
        .text('-');

    cell.append('div')
        .text('+');
}


function verticalPlusMinus(cell) {
    cell.selectAll("*").remove();

    cell.append('span')
        .text('-');

    cell.append('span')
        .text('+')
      .on("click", function () {
        example_count += 1;
        main();
      });
}


function addPlusMinuses() {
    tr.append('td'); // put one more td at the end

    var last_tr = d3.select('tbody')
        .append('tr');

    first_td = last_tr.append('td');

    verticalPlusMinus(first_td);

    last_tr.selectAll('td')
        .data(d3.range(rule_count))
      .enter()
        .append('td');

    last_tr.append('td');
}


function updateGrid() {
    allData = updateAllData();

    var matrix = pairOffData(allData);

    var tr = d3.selectAll('tbody tr')
        .data(matrix);

    tr.enter().append('tr');

    var td = tr.selectAll("td.result")
        .data(function (d) {return d;})

    td.enter().append('td')
        .attr('class', 'result');

    // add td div
    td.selectAll("*").remove();
    td.append('div').text(function (d) {return d.source;});
    td.append('div').text(function (d) {return d.target;}); 

    td.exit().remove();
}

function attachInput(cells) {
    cells.append("div")
        .append("input")
        .attr("value", function (d) {return d.source;})
        .attr("class", "source_rule")
        .on("keyup", updateGrid);

    cells.append("div")
        .append("input")
        .attr("value", function (d) {return d.target;})
        .attr("class", "target_rule")
        .on("keyup", updateGrid);
}


function makeHeader(header) {
    var th = header.selectAll("th")
        .data(allData.rules)
      .enter()
        .append("th");

    header.insert("th", ":first-child");

    attachInput(th);

    last_th = header.append('th');

    addHoizontalPlusMinus(last_th);
}


function addExampleInputs(tds) {

    tds.append("div")
        .append("input")
        .attr("class", "source_example")
        .on("keyup", updateGrid);

    tds.append("div")
        .append("input")
        .attr("class", "target_example")
        .on("keyup", updateGrid);
}

function makeRows(tbody) {
    var rows = tbody.selectAll("tr")
        .data(allData.examples)
      .enter()
        .append("tr");

    var tds = rows.append("td");

    addExampleInputs(tds);

}


function drawGrid() {
    makeHeader(d3.select("#grid thead"));
    makeRows(d3.select("#grid tbody"));
}


function main() {
    drawGrid();
    updateGrid();
}


$(document).ready(function () {
    main();
})



</script>

</head>
<body>
<h1>Welcome to the form forms of formulation!</h1>
<p>Oh dear, that name has got to go</p>

<h2>Step 1: Give me some info</h2>
<p>Enter some words and rules!</p>

<div id="grid">
<table>
<thead></thead>
<tbody></tbody>
</table>
</div>


</body>
</html>