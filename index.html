<html>
<head>
<title>jessicas' Forms Form</title>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="jquery.min.js"></script>

<script>
var current_width_of_grid = 4;
var current_height_of_grid = 8;

function applyRuleToExample(rule, example) {

    if (example == "") {
        return "";
    }

    var result, final_result;

    result = rule.replace("[term]", example)

    var match = /\((.+?)->(.+?)\)/g.exec(result);

    if (match) {
        result = result.replace(/\(.+?->.+?\)/, "")

        // get the string right before it
        replace_this_string_len = match[1].length;

        could_be_a_match = result.substr(match.index - replace_this_string_len, replace_this_string_len);

        if (could_be_a_match == match[1]) {
            result = result.substr(0, match.index - replace_this_string_len)
                + match[2]
                + result.substr(match.index, result.length - 1);
        }
    }

    return result;
}


function pairOffData(rules, translated_rules, examples, translated_examples) {

    result = [];
    for (var example_i=0; example_i < examples.length; example_i++) {
        var newList = [];
        for (var rule_i=0; rule_i < rules.length; rule_i++) {
            newList.push({
                "result": applyRuleToExample(
                    rules[rule_i],
                    examples[example_i]
                ),
                "translated_result": applyRuleToExample(
                    translated_rules[rule_i],
                    translated_examples[example_i]
                ),
            });
        }
        result.push(newList);
    }

    return result;
}


function updateGrid() {

    var matrix = pairOffData(
        d3.selectAll(".rule")[0].map(function(d) {return $(d).val()}),
        d3.selectAll(".translated_rule")[0].map(function(d) {return $(d).val()}),
        d3.selectAll(".example")[0].map(function(d) {return $(d).val()}),
        d3.selectAll(".translated_example")[0].map(function(d) {return $(d).val()})
    );

    var tr = d3.selectAll('tbody tr')
        .data(matrix);

    tr.enter().append('tr');

    var td = tr.selectAll("td")
        .filter(function(d, i) {return i != 0;})
        .data(function (d) {return d;});

    td.enter().append('td');

    // update old values

    td.selectAll("*").remove();
    td.append('div').text(function (d) {return d.result;});
    td.append('div').text(function (d) {return d.translated_result;});

    tr.append('td'); // put one more td at the end

    var last_tr = d3.select('tbody')
        .append('tr');

    first_td = last_tr.append('td');

    first_td.append('span')
        .text('-');

    first_td.append('span')
        .text('+');

    last_tr.selectAll('td')
        .data(d3.range(1 + current_width_of_grid))
      .enter()
        .append('td');

    last_tr.append('td');

}


function main() {

    var header = d3.select("#grid thead.row1")

    var th = header.selectAll("th")
        .data(d3.range(1 + current_width_of_grid))
        .enter()
        .append("th");

    var input_things = th.filter(function(d, i) {return i != 0;});

    input_things.append("div")
        .append("input")
        .attr("value", "[term]")
        .attr("class", "rule")
        .on("keyup", updateGrid);

    input_things.append("div")
        .append("input")
        .attr("value", "[term]")
        .attr("class", "translated_rule")
        .on("keyup", updateGrid);

    last_th = header.append('th');

    last_th.append('div')
        .text('-');

    last_th.append('div')
        .text('+');


    var rows = d3.select("#grid tbody").selectAll("tr")
        .data(d3.range(1 + current_height_of_grid))
        .enter()
        .append("tr");

    var tds = rows.append("td");

    tds.append("div").append("input")
        .attr("class", "example")
        .on("keyup", updateGrid);

    tds.append("div").append("input")
        .attr("class", "translated_example")
        .on("keyup", updateGrid);

    rows.selectAll("td")
        .data(d3.range(1 + current_width_of_grid))
        .enter()
        .append("td")
        .attr("class", "result");

    updateGrid();

}


$(document).ready(function () {
    main();
})



</script>

</head>
<body>
<h1>Welcome to the form forms of formulation!</h1>
<p>Oh dear, that name has got to go</p>

<h2>Step 1: Give me some info</h2>
<p>Enter some words and rules!</p>

<div id="grid">
<table>
<thead class="row1"></thead>
<thead class="row2"></thead>
<tbody></tbody>
</table>
</div>


</body>
</html>