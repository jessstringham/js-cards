<html>
<head>
<title>jessicas' Forms Form</title>
<script src='d3.v3.min.js' charset='utf-8'></script>
<script src='jquery.min.js'></script>

<style>
table, th, td {
   border: 1px solid black;
}

.target_result {
    background-color: #AAF;
}

.source_result {
    font-size: 24px;
}

.study_target {
    font-size: 36px;
}

.study_source {
    font-size: 36px;
}

.small_study_target {
    font-size: 14px;
}


</style>

<script>
var rule_count;
var example_count;

var allData;

function getDataFromURI() {
    var match = /\?data=(.*)(?:\&.*)?/g.exec(window.location.search);

    if (!match) {
        return false;
    }

    try {
        allData = JSON.parse(decodeURIComponent(match[1]));
        rule_count = allData.rules.length;
        example_count = allData.examples.length;
        return allData;
    } catch (e) {
        return false;
    }
}


function initAllData() {

    dataInfo = getDataFromURI();

    if (dataInfo) {
        return dataInfo;
    }

    rule_count = 3;
    example_count = 6;

    var dataInfo = {
        rules: [],
        examples: [],
        exceptions: {},
        cardScores: {},
    }

    for (var rule_i=0; rule_i < rule_count; rule_i++) {
        dataInfo.rules.push({
            target: '[term]',
            source: '[term]',
        })
    }

    for (var example_i=0; example_i < example_count; example_i++) {
        dataInfo.examples.push({
            target: '',
            source: '',
        })
    }

    return dataInfo;
}

//todo side effects or not, choose one
function updateAllData() {
    var getValFromData = function(d) {return $(d).val();};

    source_rules = d3.selectAll('.source_rule')[0].map(getValFromData);
    target_rules = d3.selectAll('.target_rule')[0].map(getValFromData);

    source_examples = d3.selectAll('.source_example')[0].map(getValFromData);
    target_examples = d3.selectAll('.target_example')[0].map(getValFromData);

    blank = {
        rules: [],
        examples: [],
        exceptions: allData.exceptions,
        cardScores: allData.cardScores,
    }

    for (var rule_i=0; rule_i < rule_count; rule_i++) {
        blank.rules.push({
            source: source_rules[rule_i],
            target: target_rules[rule_i],
        })
    }

    for (var example_i=0; example_i < example_count; example_i++) {
        blank.examples.push({
            source: source_examples[example_i],
            target: target_examples[example_i],
        })
    }

    return blank;
}

function addRule() {
    rule_count += 1;

    allData.rules.push({
        target: '[term]',
        source: '[term]',
    })

    drawGrid();
    updateGrid();
}

function addExample() {
    example_count += 1;

    allData.examples.push({
        target: '',
        source: '',
    })

    drawGrid();
    updateGrid();
}


function applyRuleToExample(rule, example) {

    if (example == '') {
        return '';
    }

    var result;

    result = rule.replace('[term]', example);

    var match = /\((.+?)->(.+?)\)/g.exec(result);

    if (match) {
        result = result.replace(/\(.+?->.+?\)/, '');

        // get the string right before it
        replace_this_string_len = match[1].length;

        could_be_a_match = result.substr(match.index - replace_this_string_len, replace_this_string_len);

        if (could_be_a_match == match[1]) {
            result = result.substr(0, match.index - replace_this_string_len)
                + match[2]
                + result.substr(match.index, result.length - 1);
        }
    }

    return result;
}


function createMatrixDataForType(type, data) {

    if (allData.exceptions.hasOwnProperty(hashRuleExample(data))) {
        is_exception = true;
        text = allData.exceptions[hashRuleExample(data)];;
    } else {
        is_exception = false;
        text = applyRuleToExample(data.rule, data.example);
    }

    return {
        type: type,  // todo, data has and needs this, can we drop this one?
        text: text,
        is_exception: is_exception,
        data: data,
    }
}



function pairOffData(allData) {

    result = [];
    for (var example_i=0; example_i < example_count; example_i++) {
        var newList = [];
        for (var rule_i=0; rule_i < rule_count; rule_i++) {

            // meh, we could do this earlier, but it's just lookup
            var current_rule = allData.rules[rule_i];
            var current_example = allData.examples[example_i];

            var source_data = {
                type: 'source',
                rule: current_rule.source,
                example: current_example.source,
            }

            var target_data = {
                type: 'target',
                rule: current_rule.target,
                example: current_example.target,
            }

            var score = allData.cardScores[hashRuleExample(source_data)];

            newList.push({
                source: createMatrixDataForType('source', source_data),
                target: createMatrixDataForType('target', target_data),
                score: score,
            });
        }
        result.push(newList);
    }

    return result;
}


function updateExceptions() {
    d3.selectAll('tbody tr.example')
        .selectAll('td.result').selectAll('div').selectAll('input')
        .each(function (d, i) {
            allData.exceptions[hashRuleExample(d.data)] = $(this).val();
        });
}


function updateGrid() {
    updateExceptions();

    allData = updateAllData();

    var matrix = pairOffData(allData);

    var tr = d3.selectAll('tbody tr.example')
        .data(matrix);

    var td = tr.selectAll('td.result')
        .data(function (d) {return d;})

    td.enter().append('td')
        .attr('class', 'result');

    // add td div
    td.selectAll('*').remove();

    td.selectAll('div')
        .data(function (d) {return [d.source, d.target];})
      .enter()
        .append('div')
        .attr('class', function (d) {
            return d.type + (d.is_exception ? '_result' : '_result exception');
        })
        .text(function (d) {return d.text || '\u00A0';})
        .on('click', function (d) {enterException(this, d);});

    td.exit().remove();

    commitData(allData);

}

function commitData(newData) {
    var updatedURL = window.location.protocol + "//" + window.location.host + window.location.pathname + '?data=' + encodeURIComponent(JSON.stringify(newData));
    window.history.pushState({path:updatedURL}, '', updatedURL);
}

function hashRuleExample(rule) {
    return JSON.stringify(rule);
}


function enterException(box, full_data) {
    result_box = d3.select(box);
    result_box.on('click', function () {});

    result_box.text('');

    input_box = result_box.append('span');
    input_box.append('input')
        .attr('value', full_data.text);
}

function attachRuleInput(cells) {

    cells.append('div')
        .append('input')
        .attr('value', function (d) {return d.source;})
        .attr('class', 'source_rule')
        .on('keyup', updateGrid);

    cells.append('div')
        .append('input')
        .attr('value', function (d) {return d.target;})
        .attr('class', 'target_rule')
        .on('keyup', updateGrid);

}


function makeHeader(header) {
    var th = header.selectAll('th.rule')
        .data(allData.rules)
      .enter()
        .append('th')
        .attr('class', 'rule');

    attachRuleInput(th);
}


function addExampleInputs(tds) {

    tds.append('div')
        .append('input')
        .attr('value', function (d) {return d.source;})
        .attr('class', 'source_example')
        .on('keyup', updateGrid);

    tds.append('div')
        .append('input')
        .attr('value', function (d) {return d.target;})
        .attr('class', 'target_example')
        .on('keyup', updateGrid);
}

function makeRows(tbody) {
    var rows = tbody.selectAll('tr.example')
        .data(allData.examples)
      .enter()
        .append('tr')
        .attr('class', 'example');

    var tds = rows.append('td');

    addExampleInputs(tds);

}


function drawGrid() {
    makeHeader(d3.select('#grid thead'));
    makeRows(d3.select('#grid tbody'));
    appendPlusMinusGrid();
}

function addExamplePlusMinus() {

    var tr = d3.select('tbody')
        .append('tr');

    tr.attr('class', 'plusMinus');

    var cell = tr.append('td');
        

    cell.selectAll('*').remove();

    cell.append('span')
        .text('-');

    cell.append('span')
        .text('+')
      .on('click', addExample);
}


function addRulePlusMinus() {
    cell = d3.select('#grid thead')
        .append('th')
        .attr('class', 'plusMinus');

    cell.selectAll('*').remove();

    cell.append('div')
        .text('-');

    cell.append('div')
        .text('+')
      .on('click', addRule);
}


function appendPlusMinusGrid() {
    d3.selectAll('.plusMinus').remove();
    addExamplePlusMinus();
    addRulePlusMinus();
}

function main() {
    // draw the first th
    d3.select('#grid thead').insert('th');
    drawGrid();
    updateGrid();
}

var currentState = 'getInput';

var transitionFunctions = {
    'getInput': getInputToTest,
}

function checkIfCellIsEmpty(cell) {
    return (!(cell.source.text === "" && cell.target.text === ""));
}

// todo, rewrite 
function clearMatrix(matrix) {
    return matrix.filter(function (d) {
        return (d[0].source.data.example !== "");
    });
}

function drawNextButton() {
    d3.select('div#grid').selectAll('*').remove();

    matrix = pairOffData(allData);

    matrix = clearMatrix(matrix);

    var tbody = d3.select('div#grid')
        .append('table')
        .append('tbody');

    tbody.selectAll('tr')
        .data(matrix)
      .enter()
        .append('tr')
        .selectAll('td')
        .data(function (d) {return d;})
      .enter()
        .append('td')
        .attr('class', 'final_score')
        .attr('bgcolor', function (d) {
            return d3.hsl('#33F')
                .brighter(computeScore(d.score))
                .toString();
            })
        .selectAll('div')
        .data(function (d) {return [d.source, d.target]})
      .enter()
        .append('div')
        .text(function (d) {return d.text;});

}

function computeScore(cardScores) {
    return d3.sum(cardScores)/cardScores.length;
}

function studyTime(cards) {
    var card_i = 0;

    function scoreCard(card, score) {
        card_data = card.source.data;

        if (!allData.cardScores.hasOwnProperty(hashRuleExample(card_data))) {
            allData.cardScores[hashRuleExample(card_data)] = [];
        }

        allData.cardScores[hashRuleExample(card_data)].push(score);
        commitData(allData);

        card_i++;

        if (card_i < cards.length) {
            drawCard(cards[card_i]);
        } else {
            drawNextButton();
        }
        
    }

    function flipCard(card) {
        d3.select('div#feels').selectAll('*').remove();
        d3.select('div#card').selectAll('*').remove();


        d3.select('div#card')
            .attr('class', 'study_source')
            .text(card.source.text);

        d3.select('div#card')
            .append('div')
            .attr('class', 'small_study_target')
            .text(card.target.text);

        d3.select('div#feels')
            .append('button')
            .text(':(')
            .on('click', function () {
                scoreCard(card, 0)
            });

        d3.select('div#feels')
            .append('button')
            .text(':D')
            .on('click', function () {
                scoreCard(card, 1)
            });
    }

    function drawCard(card) {
        d3.select('div#feels').selectAll('*').remove();

        d3.select('div#card')
            .attr('class', 'study_target')
            .text(card.target.text);

        d3.select('div#feels')
            .append('button')
            .attr('class', 'flip_it')
            .text('flip it')
            .on('click', function () {
                flipCard(card);
            });
    }

    d3.select('div#grid')
        .append('div')
        .attr('id', 'feels');

    d3.select('div#grid')
        .append('div')
        .attr('id', 'card');

    drawCard(cards[card_i]);
}

function getInputToTest() {
    allData = updateAllData();

    d3.select('div#grid').selectAll('*').remove();
    updateExceptions();

    var matrix = pairOffData(allData);

    var cards = matrix.reduce(function (a, b) {
        return a.concat(b);
    })

    cards = cards.filter(checkIfCellIsEmpty);
    cards = d3.shuffle(cards);
    studyTime(cards);

    return 'test';
}


function changeState() {
    currentState = transitionFunctions[currentState]();
}


function setupButton() {
    d3.select('button#next')
        .text('Wheee, let\'s go!')
        .on('click', changeState);
}


$(document).ready(function () {
    allData = initAllData();
    main();
    setupButton();
})



</script>

</head>
<body>
<h1>Study time!</h1>

<div>
<p><button id='next'></button></p>
</div>

<div id='grid'>
<table>
<thead></thead>
<tbody></tbody>
</table>
</div>



</body>
</html>