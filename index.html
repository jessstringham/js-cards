<html>
<head>
<title>jessicas' Forms Form</title>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="jquery.min.js"></script>

<style>
table, th, td {
   border: 1px solid black;
}

</style>

<script>
var rule_count = 3;
var example_count = 6;

var allData = initAllData();


function initAllData() {
    blank = {
        rules: [],
        examples: [],
        exceptions: [],
    }

    for (var rule_i=0; rule_i < rule_count; rule_i++) {
        blank.rules.push({
            target: "[term]",
            source: "[term]",
        })
    }

    for (var example_i=0; example_i < example_count; example_i++) {
        blank.examples.push({
            target: "",
            source: "",
        })
    }

    return blank;
}


function updateAllData() {
    var getValFromData = function(d) {return $(d).val();};

    source_rules = d3.selectAll(".source_rule")[0].map(getValFromData);
    target_rules = d3.selectAll(".target_rule")[0].map(getValFromData);

    source_examples = d3.selectAll(".source_example")[0].map(getValFromData);
    target_examples = d3.selectAll(".target_example")[0].map(getValFromData);

    blank = {
        rules: [],
        examples: [],
    }

    for (var rule_i=0; rule_i < rule_count; rule_i++) {
        blank.rules.push({
            source: source_rules[rule_i],
            target: target_rules[rule_i],
        })
    }

    for (var example_i=0; example_i < example_count; example_i++) {
        blank.examples.push({
            source: source_examples[example_i],
            target: target_examples[example_i],
        })
    }

    return blank;
}

function addRule() {
    rule_count += 1;

    allData.rules.push({
        target: "[term]",
        source: "[term]",
    })

    drawGrid();
    updateGrid();
}

function addExample() {
    example_count += 1;

    allData.examples.push({
        target: "",
        source: "",
    })

    drawGrid();
    updateGrid();
}


function applyRuleToExample(rule, example) {

    if (example == "") {
        return "";
    }

    var result;

    result = rule.replace("[term]", example);

    var match = /\((.+?)->(.+?)\)/g.exec(result);

    if (match) {
        result = result.replace(/\(.+?->.+?\)/, "")

        // get the string right before it
        replace_this_string_len = match[1].length;

        could_be_a_match = result.substr(match.index - replace_this_string_len, replace_this_string_len);

        if (could_be_a_match == match[1]) {
            result = result.substr(0, match.index - replace_this_string_len)
                + match[2]
                + result.substr(match.index, result.length - 1);
        }
    }

    return result;
}


function pairOffData(allData) {

    result = [];
    for (var example_i=0; example_i < example_count; example_i++) {
        var newList = [];
        for (var rule_i=0; rule_i < rule_count; rule_i++) {

            newList.push({
                source: applyRuleToExample(
                    allData.rules[rule_i].source,
                    allData.examples[example_i].source
                ),
                target: applyRuleToExample(
                    allData.rules[rule_i].target,
                    allData.examples[example_i].target
                ),
            });
        }
        result.push(newList);
    }

    return result;
}




function updateGrid() {
    allData = updateAllData();

    var matrix = pairOffData(allData);

    var tr = d3.selectAll('tbody tr.example')
        .data(matrix);

    var td = tr.selectAll("td.result")
        .data(function (d) {return d;})

    td.enter().append('td')
        .attr('class', 'result');

    // add td div
    td.selectAll("*").remove();

    source_result = td.append('div');
    source_result.append('span')
        .text(function (d) {return d.source;});
    source_result.on("click", function (d) { enterException(this, d.source); });


    target_result = td.append('div');
    target_result.append('span')
        .text(function (d) {return d.target;});
    target_result.on("click", function (d) { enterException(this, d.target); });

    td.exit().remove();
}

function enterException(box, text) {

    result_box = d3.select(box);
    result_box.on('click', function () {});

    result_box.selectAll("*").remove();

    input_box = result_box.append('span')
    input_box.append('input').attr("value", text);
    input_box.append('span').text(":D").on('click', function () {});
    input_box.append('span').text("X").on('click', function () {});


}


function addException(input, data) {
    allData.exceptions[data] = input;
}

function attachRuleInput(cells) {
    cells.append("div")
        .append("input")
        .attr("value", function (d) {return d.source;})
        .attr("class", "source_rule")
        .on("keyup", updateGrid);

    cells.append("div")
        .append("input")
        .attr("value", function (d) {return d.target;})
        .attr("class", "target_rule")
        .on("keyup", updateGrid);
}


function makeHeader(header) {
    var th = header.selectAll("th.rule")
        .data(allData.rules)
      .enter()
        .append("th")
        .attr("class", "rule");

    attachRuleInput(th);
}


function addExampleInputs(tds) {

    tds.append("div")
        .append("input")
        .attr("class", "source_example")
        .on("keyup", updateGrid);

    tds.append("div")
        .append("input")
        .attr("class", "target_example")
        .on("keyup", updateGrid);
}

function makeRows(tbody) {
    var rows = tbody.selectAll("tr.example")
        .data(allData.examples)
      .enter()
        .append("tr")
        .attr("class", "example");

    var tds = rows.append("td");

    addExampleInputs(tds);

}


function drawGrid() {
    makeHeader(d3.select("#grid thead"));
    makeRows(d3.select("#grid tbody"));
    appendPlusMinusGrid();
}

function addExamplePlusMinus() {

    var tr = d3.select('tbody')
        .append('tr');

    tr.attr('class', 'plusMinus');

    var cell = tr.append('td');
        

    cell.selectAll("*").remove();

    cell.append('span')
        .text('-');

    cell.append('span')
        .text('+')
      .on("click", addExample);
}


function addRulePlusMinus() {
    cell = d3.select("#grid thead")
        .append('th')
        .attr('class', 'plusMinus');

    cell.selectAll("*").remove();

    cell.append('div')
        .text('-');

    cell.append('div')
        .text('+')
      .on("click", addRule);
}


function appendPlusMinusGrid() {
    d3.selectAll('.plusMinus').remove();
    addExamplePlusMinus();
    addRulePlusMinus();
}

function main() {
    // draw the first th
    d3.select("#grid thead").insert("th");
    drawGrid();
    updateGrid();
}


$(document).ready(function () {
    main();
})



</script>

</head>
<body>
<h1>Welcome to the form forms of formulation!</h1>
<p>Oh dear, that name has got to go</p>

<h2>Step 1: Give me some info</h2>
<p>Enter some words and rules!</p>

<div id="grid">
<table>
<thead></thead>
<tbody></tbody>
</table>
</div>


</body>
</html>